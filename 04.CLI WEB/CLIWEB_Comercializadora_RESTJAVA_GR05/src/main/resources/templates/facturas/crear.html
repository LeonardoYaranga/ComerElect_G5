<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crear Nueva Factura - Comercializadora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header>
        <nav class="navbar shadow-lg z-[100]">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <a th:href="@{/dashboard}" class="text-white font-bold text-xl">
                                <i class="fas fa-store"></i> Comercializadora
                            </a>
                        </div>
                        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                            <a th:href="@{/dashboard}" class="text-white hover:text-yellow-300 px-3 py-2 rounded-md text-sm font-medium transition duration-300">
                                <i class="fas fa-home"></i> Dashboard
                            </a>
                            <a th:href="@{/facturas/crear}" class="text-white hover:text-yellow-300 px-3 py-2 rounded-md text-sm font-medium transition duration-300">
                                <i class="fas fa-plus-circle"></i> Crear Factura
                            </a>
                            <a th:href="@{/facturas/consultar}" class="text-white hover:text-yellow-300 px-3 py-2 rounded-md text-sm font-medium transition duration-300">
                                <i class="fas fa-file-invoice"></i> Consultar Facturas
                            </a>
                            <a th:href="@{/electrodomesticos}" class="text-white hover:text-yellow-300 px-3 py-2 rounded-md text-sm font-medium transition duration-300">
                                <i class="fas fa-box"></i> Electrodomésticos
                            </a>
                        </div>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:items-center sm:space-x-4">
                        <span class="text-white px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-user"></i> <span th:text="${session.usuario != null ? session.usuario : 'Usuario'}"></span>
                        </span>
                        <a th:href="@{/logout}" class="text-white hover:text-yellow-300 px-3 py-2 rounded-md text-sm font-medium transition duration-300">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </a>
                    </div>
                    <div class="flex items-center sm:hidden">
                        <button type="button" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-white hover:text-yellow-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                            <span class="sr-only">Open main menu</span>
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="sm:hidden" id="mobile-menu">
                <div class="px-2 pt-2 pb-3 space-y-1">
                    <a th:href="@{/dashboard}" class="text-white hover:text-yellow-300 block px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <a th:href="@{/facturas/crear}" class="text-white hover:text-yellow-300 block px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-plus-circle"></i> Crear Factura
                    </a>
                    <a th:href="@{/facturas/consultar}" class="text-white hover:text-yellow-300 block px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-file-invoice"></i> Consultar Facturas
                    </a>
                    <a th:href="@{/electrodomesticos}" class="text-white hover:text-yellow-300 block px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-box"></i> Electrodomésticos
                    </a>
                    <div class="border-t border-gray-600 pt-2">
                        <span class="text-white block px-3 py-2 rounded-md text-base font-medium">
                            <i class="fas fa-user"></i> <span th:text="${session.usuario != null ? session.usuario : 'Usuario'}"></span>
                        </span>
                        <a th:href="@{/logout}" class="text-white hover:text-yellow-300 block px-3 py-2 rounded-md text-base font-medium">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="flex-1">
        <div class="container mx-auto px-4 py-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-8"><i class="fas fa-file-invoice text-blue-600"></i> Crear Nueva Factura</h2>

        <!-- Mensaje de Error -->
        <div th:if="${error != null}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6 relative" role="alert">
            <strong class="font-bold">Error:</strong>
            <span class="block sm:inline" th:text="${error}"></span>
            <button type="button" class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.style.display='none'">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Mensaje de Éxito -->
        <div th:if="${mensaje != null}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6 relative" role="alert">
            <strong class="font-bold">Éxito:</strong>
            <span class="block sm:inline" th:text="${mensaje}"></span>
            <button type="button" class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.style.display='none'">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form th:action="@{/facturas/crear}" method="post" id="formFactura" class="space-y-8">
            <!-- Datos del Cliente -->
            <div class="bg-white rounded-lg shadow-lg">
                <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg">
                    <h5 class="text-xl font-semibold mb-0"><i class="fas fa-user"></i> Datos del Cliente</h5>
                </div>
                <div class="p-6">
                    <div class="max-w-md">
                        <label for="cedula" class="block text-sm font-medium text-gray-700">Cédula</label>
                        <input type="text" id="cedula" name="cedula" maxlength="10" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="1234567890" required />
                        <small class="text-gray-500">La validación de crédito se realizará al generar la factura</small>
                    </div>
                </div>
            </div>

            <!-- Productos -->
            <div class="bg-white rounded-lg shadow-lg">
                <div class="bg-green-600 text-white px-6 py-4 rounded-t-lg">
                    <h5 class="text-xl font-semibold mb-0"><i class="fas fa-box"></i> Productos</h5>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="inputCodigoProducto" class="block text-sm font-medium text-gray-700">Buscar Producto por Código</label>
                            <input type="text" id="inputCodigoProducto" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="ELEC001" />
                        </div>
                        <div>
                            <label for="inputCantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                            <input type="number" id="inputCantidad" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" value="1" min="1" />
                        </div>
                        <div class="flex items-end">
                            <button type="button" id="btnAgregarProducto" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-300">
                                <i class="fas fa-plus-circle"></i> Agregar
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto mb-6">
                        <table class="min-w-full divide-y divide-gray-200" id="tablaProductos">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Imagen</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Código</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Nombre</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Precio Unit.</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">Cantidad</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Subtotal</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productosCarrito" class="bg-white divide-y divide-gray-200">
                                <tr id="noProductos">
                                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                        No hay productos agregados
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Resumen de Totales -->
                    <div class="flex justify-end">
                        <div class="w-full md:w-1/3">
                            <table class="min-w-full">
                                <tr>
                                    <td class="py-2"><strong>Subtotal:</strong></td>
                                    <td class="py-2 text-right">$<span id="subtotal">0.00</span></td>
                                </tr>
                                <tr>
                                    <td class="py-2"><strong>IVA (15%):</strong></td>
                                    <td class="py-2 text-right">$<span id="iva">0.00</span></td>
                                </tr>
                                <tr id="filaDescuento" style="display:none;">
                                    <td class="py-2"><strong>Descuento (33%):</strong></td>
                                    <td class="py-2 text-right text-green-600">-$<span id="descuento">0.00</span></td>
                                </tr>
                                <tr class="bg-blue-50">
                                    <td class="py-2"><strong>TOTAL:</strong></td>
                                    <td class="py-2 text-right"><strong>$<span id="total">0.00</span></strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tipo de Pago -->
            <div class="bg-white rounded-lg shadow-lg">
                <div class="bg-yellow-500 text-white px-6 py-4 rounded-t-lg">
                    <h5 class="text-xl font-semibold mb-0"><i class="fas fa-credit-card"></i> Tipo de Pago</h5>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div class="flex items-center mb-4">
                                <input class="form-radio h-4 w-4 text-green-600" type="radio" name="tipoPago" id="radioEfectivo" value="Efectivo" required />
                                <label class="ml-2 block text-sm font-medium text-gray-700" for="radioEfectivo">
                                    <i class="fas fa-money-bill-wave text-green-600"></i> Efectivo (33% de descuento)
                                </label>
                            </div>
                            <div id="infoEfectivo" style="display:none;" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                                <strong>Descuento aplicado: $<span id="montoDescuento">0.00</span></strong><br/>
                                Total a pagar: $<span id="totalEfectivo">0.00</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center mb-4">
                                <input class="form-radio h-4 w-4 text-blue-600" type="radio" name="tipoPago" id="radioCredito" value="Credito" />
                                <label class="ml-2 block text-sm font-medium text-gray-700" for="radioCredito">
                                    <i class="fas fa-credit-card text-blue-600"></i> Crédito
                                </label>
                            </div>
                            <div id="opcionesCredito" style="display:none;" class="space-y-4">
                                <div>
                                    <label for="numeroCuotas" class="block text-sm font-medium text-gray-700">Número de Cuotas (3-24 meses)</label>
                                    <input type="number" id="numeroCuotas" name="numeroCuotas" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" min="3" max="24" />
                                </div>
                                <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">
                                    <i class="fas fa-info-circle"></i> <strong>Nota:</strong> La validación de crédito se realizará automáticamente al generar la factura.
                                </div>
                                <div id="infoCredito2" class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded" style="display:none;">
                                    <strong>Cuota mensual estimada: $<span id="cuotaMensual">0.00</span></strong><br/>
                                    Tasa de interés: <span id="tasaInteres">15</span>% anual
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="flex justify-end space-x-3">
                <a href="/dashboard" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-300">
                    <i class="fas fa-times"></i> Cancelar
                </a>
                <button type="submit" id="btnGenerarFactura" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-300" disabled>
                    <i class="fas fa-save"></i> Generar Factura
                </button>
            </div>
        </form>
    </div>

    <script>
        let productosCarrito = [];

        $('#btnAgregarProducto').click(async function() {
            const codigo = $('#inputCodigoProducto').val();
            const cantidad = parseInt($('#inputCantidad').val());

            if (!codigo) {
                alert('Ingrese el código del producto');
                return;
            }

            try {
                const response = await fetch('http://192.168.137.1:8081/api/electrodomesticos/' + codigo);
                if (response.ok) {
                    const electrodomestico = await response.json();
                    const result = { success: true, data: electrodomestico };

                    if (result.success) {
                        const producto = {
                            codigo: result.data.codigo,
                            nombre: result.data.nombre,
                            precio: result.data.precio,
                            cantidad: cantidad,
                            subtotal: result.data.precio * cantidad,
                            imageUrl: result.data.imageUrl
                        };

                        productosCarrito.push(producto);
                        actualizarTablaProductos();
                        calcularTotales();

                        $('#inputCodigoProducto').val('');
                        $('#inputCantidad').val(1);
                    } else {
                        alert('Producto no encontrado: ' + result.message);
                    }
                } else if (response.status === 404) {
                    alert('Producto no encontrado');
                } else {
                    alert('Error al buscar producto: ' + response.status);
                }
            } catch (error) {
                alert('Error al buscar producto: ' + error);
            }
        });

        function actualizarTablaProductos() {
            const tbody = $('#productosCarrito');
            tbody.empty();

            if (productosCarrito.length === 0) {
                tbody.append('<tr id="noProductos"><td colspan="7" class="px-6 py-12 text-center text-gray-500">No hay productos agregados</td></tr>');
                $('#btnGenerarFactura').prop('disabled', true);
            } else {
                productosCarrito.forEach((p, index) => {
                    const imagenHtml = p.imageUrl 
                        ? `<img src="${p.imageUrl}" alt="${p.nombre}" class="w-12 h-12 object-cover rounded" />` 
                        : `<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center"><i class="fas fa-image text-gray-400"></i></div>`;
                    
                    tbody.append(`
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">${imagenHtml}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.codigo}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.nombre}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right">$${p.precio.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${p.cantidad}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right">$${p.subtotal.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <button type="button" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded transition duration-300" onclick="eliminarProducto(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });
                $('#btnGenerarFactura').prop('disabled', false);
            }
        }

        function eliminarProducto(index) {
            productosCarrito.splice(index, 1);
            actualizarTablaProductos();
            calcularTotales();
        }

        function calcularTotales() {
            const subtotal = productosCarrito.reduce((sum, p) => sum + p.subtotal, 0);
            const iva = subtotal * 0.15;
            const tipoPago = $('input[name="tipoPago"]:checked').val();

            let descuento = 0;
            let totalBruto = subtotal + iva;
            let totalFinal = totalBruto;

            if (tipoPago === 'Efectivo') {
                descuento = totalBruto * 0.33;
                totalFinal = totalBruto - descuento;

                $('#filaDescuento').show();
                $('#descuento').text(descuento.toFixed(2));
                $('#montoDescuento').text(descuento.toFixed(2));
                $('#totalEfectivo').text(totalFinal.toFixed(2));
                $('#infoEfectivo').show();
            } else {
                $('#filaDescuento').hide();
                $('#infoEfectivo').hide();
            }

            $('#subtotal').text(subtotal.toFixed(2));
            $('#iva').text(iva.toFixed(2));
            $('#total').text(totalFinal.toFixed(2));
        }

        $('input[name="tipoPago"]').change(function() {
            const tipoPago = $(this).val();
            if (tipoPago === 'Efectivo') {
                $('#opcionesCredito').hide();
            } else {
                $('#opcionesCredito').show();
            }
            calcularTotales();
        });

        $('#numeroCuotas').on('input', function() {
            const cuotas = parseInt($(this).val());
            if (cuotas >= 3 && cuotas <= 24) {
                const total = parseFloat($('#total').text());
                const tasaAnual = 0.15;
                const tasaMensual = tasaAnual / 12;
                const cuota = total * (tasaMensual * Math.pow(1 + tasaMensual, cuotas)) / (Math.pow(1 + tasaMensual, cuotas) - 1);

                $('#cuotaMensual').text(cuota.toFixed(2));
                $('#infoCredito2').show();
            }
        });

        $('#formFactura').submit(function() {
            if (productosCarrito.length === 0) {
                alert('Debe agregar al menos un producto');
                return false;
            }

            const cedula = $('#cedula').val();
            if (!cedula || cedula.length !== 10) {
                alert('La cédula debe tener 10 dígitos');
                return false;
            }

            const tipoPago = $('input[name="tipoPago"]:checked').val();
            if (!tipoPago) {
                alert('Seleccione un tipo de pago');
                return false;
            }

            if (tipoPago === 'Credito') {
                const cuotas = parseInt($('#numeroCuotas').val());
                if (!cuotas || cuotas < 3 || cuotas > 24) {
                    alert('El número de cuotas debe estar entre 3 y 24');
                    return false;
                }
            }

            productosCarrito.forEach((p, index) => {
                $(this).append(`<input type="hidden" name="productosCarrito[${index}].codigo" value="${p.codigo}" />`);
                $(this).append(`<input type="hidden" name="productosCarrito[${index}].cantidad" value="${p.cantidad}" />`);
            });

            return true;
        });
    </script>
</main>

    <script>
        // Mobile menu toggle
        const mobileMenuButton = document.querySelector('button[aria-controls="mobile-menu"]');
        const mobileMenu = document.getElementById('mobile-menu');

        mobileMenuButton.addEventListener('click', () => {
            const expanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
            mobileMenuButton.setAttribute('aria-expanded', !expanded);
            mobileMenu.classList.toggle('hidden');
        });
    </script>
</body>
</html>